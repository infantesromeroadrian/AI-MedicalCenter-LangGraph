{% extends "base.html" %}

{% block title %}Consulta Médica Virtual - Especialistas Médicos{% endblock %}

{% block extra_css %}
<style>
    /* Estilos específicos para esta página */
    .medical-icon {
        color: var(--primary-color);
        margin-right: 8px;
    }
    
    .patient-info {
        background-color: #f8fafc;
        border-left: 4px solid var(--primary-color);
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 0 5px 5px 0;
    }
    
    .specialty-tag {
        display: inline-block;
        padding: 3px 8px;
        margin: 2px;
        border-radius: 4px;
        font-size: 0.8rem;
        color: white;
        background-color: var(--primary-color);
    }
    
    .medical-section-title {
        color: var(--primary-color);
        font-weight: 600;
        border-bottom: 1px solid #e0e0e0;
        padding-bottom: 5px;
        margin-bottom: 15px;
    }
    
    .vital-sign-badge {
        display: inline-flex;
        align-items: center;
        margin-right: 15px;
        padding: 5px 10px;
        background-color: #f5f8fa;
        border-radius: 50px;
        font-size: 0.9rem;
    }
    
    .consultation-header {
        background-color: var(--primary-color);
        color: white;
        padding: 15px;
        border-radius: 8px 8px 0 0;
        margin-bottom: 0;
    }
    
    .chat-container {
        background-color: white;
        border: 1px solid #e0e0e0;
        border-top: none;
        border-radius: 0 0 8px 8px;
        padding: 20px;
    }
    
    .doctor-message {
        background-color: #f0f7ff;
        border-left: 3px solid var(--primary-color);
    }
    
    .system-message {
        background-color: #f9f9f9;
        border-left: 3px solid #888;
    }
    
    .patient-message {
        background-color: #f0fff5;
        border-left: 3px solid var(--secondary-color);
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Banner de Hospital IA -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="alert alert-info d-flex align-items-center">
                <i class="fas fa-robot me-3 fa-2x"></i>
                <div>
                    <strong>Hospital AI Salud</strong> - Sistema de atención médica inteligente
                    <div class="small">Análisis en tiempo real • Diagnósticos avanzados • Atención personalizada</div>
                </div>
                <div class="ms-auto">
                    <span class="badge bg-success">
                        <i class="fas fa-check-circle"></i> Sistemas conectados
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Cabecera de consulta médica -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="clinical-section">
                <div class="d-flex justify-content-between align-items-center">
                    <h3 class="clinical-header mb-0">
                        <i class="fas fa-hospital-user medical-icon"></i>Consulta Médica Virtual
                    </h3>
                    <span class="badge bg-primary">ID: {{ conversation.conversation_id }}</span>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="medical-record-section">
                            <div class="medical-category">Datos de la consulta</div>
                            <p class="mb-1"><i class="fas fa-calendar-alt medical-icon"></i>Fecha: {{ now().strftime('%d/%m/%Y') }}</p>
                            <p class="mb-1"><i class="fas fa-clock medical-icon"></i>Hora: {{ now().strftime('%H:%M') }}</p>
                            <p class="mb-0"><i class="fas fa-user-md medical-icon"></i>Especialista: 
                                <span class="badge bg-success" id="active-specialty">{{ conversation.active_specialty | capitalize }}</span>
                            </p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="medical-record-section">
                            <div class="medical-category">Panel de especialistas</div>
                            <div>
                                {% for specialty in conversation.all_specialties %}
                                <span class="specialty-tag">
                                    {{ specialty | capitalize }}
                                    {% if specialty == conversation.active_specialty %}
                                    <i class="fas fa-check-circle ms-1"></i>
                                    {% endif %}
                                </span>
                                {% endfor %}
                            </div>
                            <small class="text-muted mt-2 d-block">
                                El sistema deriva automáticamente al especialista adecuado
                            </small>
                        </div>
                    </div>
                </div>
                
                <!-- Sistema de triaje IA -->
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="alert alert-light border d-flex align-items-center p-2">
                            <div class="d-flex align-items-center text-primary">
                                <i class="fas fa-heartbeat me-2"></i>
                                <strong>Triaje IA:</strong>
                            </div>
                            <div class="progress ms-3 flex-grow-1" style="height: 10px;">
                                <div class="progress-bar bg-success" role="progressbar" style="width: 75%" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <span class="badge bg-success ms-2">Prioridad normal</span>
                            <button class="btn btn-sm btn-outline-primary ms-3" data-bs-toggle="tooltip" title="Actualizado cada 5 minutos basado en sus síntomas">
                                <i class="fas fa-info-circle"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- Panel lateral con herramientas médicas -->
        <div class="col-md-3">
            <!-- Panel de monitoreo de signos vitales -->
            <div class="clinical-section mb-4">
                <h5 class="medical-section-title">
                    <i class="fas fa-heartbeat medical-icon"></i>Monitoreo IA
                    <span class="badge bg-success float-end" style="font-size: 0.6rem;">EN VIVO</span>
                </h5>
                
                <div class="vital-sign">
                    <i class="fas fa-temperature-high vital-icon"></i>
                    <div class="flex-grow-1">Temperatura</div>
                    <div class="vital-value">36.7°C</div>
                </div>
                
                <div class="vital-sign">
                    <i class="fas fa-heart vital-icon"></i>
                    <div class="flex-grow-1">Ritmo cardíaco</div>
                    <div class="vital-value">72 bpm</div>
                </div>
                
                <div class="vital-sign">
                    <i class="fas fa-lungs vital-icon"></i>
                    <div class="flex-grow-1">Respiración</div>
                    <div class="vital-value">16 rpm</div>
                </div>
                
                <div class="vital-sign">
                    <i class="fas fa-tint vital-icon"></i>
                    <div class="flex-grow-1">Presión arterial</div>
                    <div class="vital-value">120/80</div>
                </div>
                
                <div class="mt-3 text-center">
                    <span class="small text-muted">
                        <i class="fas fa-sync-alt"></i> Datos simulados con fines demostrativos
                    </span>
                </div>
            </div>
            
            <!-- Panel de historial y acciones médicas -->
            <div class="clinical-section mb-4">
                <h5 class="medical-section-title">
                    <i class="fas fa-clipboard-list medical-icon"></i>Historial médico
                </h5>
                <p class="text-muted small">Esta consulta contiene información relevante para su historial médico</p>
                <hr>
                <div class="d-grid gap-2">
                    <button id="generate-report-btn" class="btn btn-success w-100">
                        <i class="fas fa-file-medical"></i> Generar informe médico
                    </button>
                    <a href="{{ url_for('interactive.interactive_chat_home', new=1) }}" class="btn btn-danger">
                        <i class="fas fa-plus-circle"></i> Nueva consulta
                    </a>
                    
                    <!-- Opción de telemedicina -->
                    <button class="btn btn-primary w-100" id="telemedicine-btn">
                        <i class="fas fa-video"></i> Solicitar videoconsulta
                    </button>
                </div>
            </div>
            
            <!-- Panel de recursos médicos -->
            <div class="clinical-section">
                <h5 class="medical-section-title">
                    <i class="fas fa-book-medical medical-icon"></i>Recursos médicos
                </h5>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex align-items-center">
                        <i class="fas fa-pills medical-icon"></i>
                        <span>Medicamentos recetados</span>
                    </li>
                    <li class="list-group-item d-flex align-items-center">
                        <i class="fas fa-notes-medical medical-icon"></i>
                        <span>Historial de consultas</span>
                    </li>
                    <li class="list-group-item d-flex align-items-center">
                        <i class="fas fa-vial medical-icon"></i>
                        <span>Resultados de laboratorio</span>
                    </li>
                    <li class="list-group-item d-flex align-items-center">
                        <i class="fas fa-x-ray medical-icon"></i>
                        <span>Imágenes diagnósticas</span>
                    </li>
                </ul>
                <div class="text-center mt-3">
                    <a href="{{ url_for('web.index') }}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-home"></i> Volver al inicio
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Panel principal con la consulta médica -->
        <div class="col-md-9">
            <!-- Dashboard de analítica médica -->
            <div class="clinical-section mb-4">
                <h5 class="medical-section-title">
                    <i class="fas fa-chart-line medical-icon"></i>Analítica IA
                    <button class="btn btn-sm btn-outline-primary float-end">
                        <i class="fas fa-expand-alt"></i> Ampliar
                    </button>
                </h5>
                <div class="row">
                    <div class="col-md-4">
                        <div class="card border-0 bg-light">
                            <div class="card-body text-center">
                                <div class="h1 mb-3">
                                    <span class="badge rounded-pill bg-primary">92%</span>
                                </div>
                                <h6 class="text-muted">Precisión diagnóstica</h6>
                                <div class="small text-success">
                                    <i class="fas fa-arrow-up"></i> 3% desde última consulta
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-0 bg-light">
                            <div class="card-body text-center">
                                <div class="h1 mb-3">
                                    <span class="text-success">4</span>/<span class="text-muted">5</span>
                                </div>
                                <h6 class="text-muted">Adherencia a tratamiento</h6>
                                <div class="small text-warning">
                                    <i class="fas fa-minus"></i> Sin cambios
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-0 bg-light">
                            <div class="card-body text-center">
                                <div class="h1 mb-3 text-primary">
                                    <i class="fas fa-calendar-check"></i>
                                </div>
                                <h6 class="text-muted">Próxima revisión</h6>
                                <div class="small">En 14 días</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="text-center mt-3">
                    <span class="badge bg-light text-muted">Los datos se analizan en tiempo real</span>
                </div>
            </div>
        
            <h4 class="consultation-header d-flex justify-content-between align-items-center">
                <span>
                    <i class="fas fa-comment-medical"></i> 
                    Consulta con Dr. <span id="header-specialty">{{ conversation.active_specialty | capitalize }}</span>
                </span>
                <span class="badge bg-light text-dark">En curso</span>
            </h4>
            
            <div class="chat-container">
                <!-- Historial de la conversación médica -->
                <div id="chat-messages" class="mb-4" style="height: 350px; overflow-y: auto;">
                    {% for message in conversation.messages %}
                    <div class="message mb-3 {% if message.sender == 'user' %}text-end{% endif %}">
                        <div class="message-content p-3 rounded 
                            {% if message.sender == 'user' %}
                                patient-message float-end
                            {% elif message.sender == 'system' %}
                                system-message
                            {% else %}
                                doctor-message
                            {% endif %}
                            " style="max-width: 85%; display: inline-block;">
                            {{ message.content }}
                        </div>
                        <div class="clearfix"></div>
                        <small class="text-muted {% if message.sender == 'user' %}text-end{% endif %} d-block mt-1">
                            {% if message.sender == 'user' %}
                                <i class="fas fa-user"></i> Paciente
                            {% elif message.sender == 'system' %}
                                <i class="fas fa-cog"></i> Sistema
                            {% else %}
                                <i class="fas fa-user-md"></i> Dr. {{ message.sender | capitalize }}
                            {% endif %}
                            - {{ message.timestamp | replace('T', ' ') | replace('Z', '') }}
                        </small>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Formulario para enviar mensajes médicos -->
                <div class="clinical-section" style="margin-bottom:0;">
                    <form id="message-form">
                        <div class="input-group">
                            <span class="input-group-text bg-light">
                                <i class="fas fa-user text-primary"></i>
                            </span>
                            <input type="text" id="message-input" name="message" class="form-control" 
                                placeholder="Describa sus síntomas o haga una pregunta médica..." required />
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane"></i> Enviar
                            </button>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i> 
                                Sea específico acerca de sus síntomas para recibir una mejor atención médica
                            </small>
                            
                            <div class="btn-group">
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="voice-input-btn">
                                    <i class="fas fa-microphone"></i> Voz
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="upload-image-btn">
                                    <i class="fas fa-camera"></i> Imagen
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para mostrar el informe médico con estilo clínico -->
<div class="modal fade" id="report-modal" tabindex="-1" aria-labelledby="report-modal-label" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="report-modal-label">
            <i class="fas fa-file-medical"></i> Informe Médico Oficial
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div id="report-loading" class="text-center p-4">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Generando informe...</span>
          </div>
          <p class="mt-3">Generando informe médico completo, por favor espere...</p>
        </div>
        <div id="report-content" class="d-none">
          <!-- El contenido del informe se insertará aquí -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times"></i> Cerrar
        </button>
        <button type="button" class="btn btn-primary" id="download-report-btn">
            <i class="fas fa-download"></i> Descargar PDF
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de telemedicina -->
<div class="modal fade" id="telemedicine-modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">
            <i class="fas fa-video"></i> Videoconsulta IA
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body text-center">
        <div class="p-3">
            <i class="fas fa-robot text-primary" style="font-size: 4rem;"></i>
            <h4 class="mt-3">Consulta por videollamada</h4>
            <p class="text-muted">Un médico especialista asistido por IA le atenderá en directo</p>
            
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> 
                Próxima disponibilidad: <strong>10 minutos</strong>
            </div>
            
            <form>
                <div class="mb-3">
                    <label class="form-label">Seleccione especialista:</label>
                    <select class="form-select">
                        <option>Dr. IA {{ conversation.active_specialty | capitalize }} (Inmediato)</option>
                        <option>Dr. López - {{ conversation.active_specialty | capitalize }} (30 min)</option>
                        <option>Dra. Gómez - {{ conversation.active_specialty | capitalize }} (45 min)</option>
                    </select>
                </div>
            </form>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary">Programar videoconsulta</button>
      </div>
    </div>
  </div>
</div>

<!-- Plantilla para nuevos mensajes -->
<template id="message-template">
    <div class="message mb-3">
        <div class="message-content p-3 rounded" style="max-width: 85%; display: inline-block;">
            <span class="message-text"></span>
        </div>
        <div class="clearfix"></div>
        <small class="text-muted d-block mt-1">
            <span class="message-sender"></span>
            <span class="message-time"></span>
        </small>
    </div>
</template>

{% endblock %}

{% block extra_js %}
<script>
    // Cuando el DOM esté listo
    document.addEventListener('DOMContentLoaded', function() {
        console.log("DOM cargado, inicializando componentes...");
        
        // Inicializar el modal de Bootstrap
        var reportModal;
        var telemedicineModal;
        
        try {
            var reportModalEl = document.getElementById('report-modal');
            var telemedicineModalEl = document.getElementById('telemedicine-modal');
            
            if (reportModalEl) {
                reportModal = new bootstrap.Modal(reportModalEl);
            }
            
            if (telemedicineModalEl) {
                telemedicineModal = new bootstrap.Modal(telemedicineModalEl);
            }
            
            // Inicializar tooltips de Bootstrap
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
            });
            
            console.log("Componentes inicializados correctamente");
        } catch (err) {
            console.error("Error inicializando componentes:", err);
        }
        
        // Sistema de triaje automático basado en IA
        function evaluarTriaje() {
            // Palabras clave que indican diferentes niveles de prioridad
            const palabrasEmergencia = ['sangrado abundante', 'dificultad para respirar', 'dolor intenso', 'desmayo', 
                'inconsciente', 'ataque', 'convulsión', 'infarto', 'accidente', 'traumatismo', 'no responde',
                'sangra', 'no puedo respirar', 'asfixia', 'ahogo', 'fiebre alta', 'vómito con sangre'];
            
            const palabrasUrgente = ['dolor', 'fiebre', 'vómito', 'diarrea', 'mareo', 'dolor de cabeza', 
                'migraña', 'náuseas', 'lesión', 'fractura', 'deshidratación', 'infección', 'alergia grave'];
            
            const palabrasNormal = ['consulta', 'seguimiento', 'revisión', 'medicamento', 'receta', 'información',
                'leve', 'moderado', 'mejorando', 'crónico', 'rutina', 'control'];
            
            // Obtener mensajes del chat
            const mensajes = document.querySelectorAll('.message-content');
            let textoCompleto = '';
            
            // Concatenar todos los mensajes para analizar
            mensajes.forEach(mensaje => {
                textoCompleto += ' ' + mensaje.textContent.toLowerCase();
            });
            
            // Contar coincidencias para cada nivel de prioridad
            let contadorEmergencia = 0;
            let contadorUrgente = 0;
            let contadorNormal = 0;
            
            // Buscar palabras de emergencia
            palabrasEmergencia.forEach(palabra => {
                if (textoCompleto.includes(palabra.toLowerCase())) {
                    contadorEmergencia += 1;
                }
            });
            
            // Buscar palabras urgentes
            palabrasUrgente.forEach(palabra => {
                if (textoCompleto.includes(palabra.toLowerCase())) {
                    contadorUrgente += 1;
                }
            });
            
            // Buscar palabras normales
            palabrasNormal.forEach(palabra => {
                if (textoCompleto.includes(palabra.toLowerCase())) {
                    contadorNormal += 1;
                }
            });
            
            // Determinar la prioridad basada en los contadores
            let prioridad, porcentaje, colorBarra;
            
            if (contadorEmergencia >= 2) {
                prioridad = "Emergencia";
                porcentaje = 95;
                colorBarra = "bg-danger";
            } else if (contadorEmergencia == 1 || contadorUrgente >= 3) {
                prioridad = "Urgente";
                porcentaje = 85;
                colorBarra = "bg-warning";
            } else if (contadorUrgente >= 1) {
                prioridad = "Prioritario";
                porcentaje = 70;
                colorBarra = "bg-primary";
            } else {
                prioridad = "Normal";
                porcentaje = 50;
                colorBarra = "bg-success";
            }
            
            // Actualizar la UI con los resultados
            const progressBar = document.querySelector('.progress-bar');
            const priorityBadge = document.querySelector('.progress').nextElementSibling;
            
            if (progressBar) {
                progressBar.style.width = porcentaje + '%';
                progressBar.setAttribute('aria-valuenow', porcentaje);
                progressBar.className = 'progress-bar ' + colorBarra;
            }
            
            if (priorityBadge) {
                priorityBadge.textContent = 'Prioridad: ' + prioridad;
                priorityBadge.className = 'badge ms-2 ' + colorBarra;
            }
            
            console.log(`Triaje IA: Prioridad ${prioridad} (${porcentaje}%) - E:${contadorEmergencia} U:${contadorUrgente} N:${contadorNormal}`);
            return { prioridad, porcentaje, colorBarra };
        }
        
        // Sistema de analítica IA - Calcula métricas basadas en la conversación
        function actualizarAnaliticaIA() {
            // Obtener todos los mensajes del chat
            const mensajes = document.querySelectorAll('.message-content');
            let textoCompleto = '';
            let mensajesUsuario = [];
            let mensajesMedico = [];
            
            // Separar mensajes por remitente
            mensajes.forEach(mensaje => {
                const contenido = mensaje.textContent.toLowerCase();
                textoCompleto += ' ' + contenido;
                
                // Determinar si es mensaje de usuario o médico
                if (mensaje.classList.contains('patient-message')) {
                    mensajesUsuario.push(contenido);
                } else if (mensaje.classList.contains('doctor-message')) {
                    mensajesMedico.push(contenido);
                }
            });
            
            // 1. Calcular precisión diagnóstica (basada en coherencia de respuestas del médico)
            let precisionDiagnostica = calcularPrecisionDiagnostica(mensajesMedico, textoCompleto);
            
            // 2. Calcular adherencia al tratamiento (basada en respuestas del paciente)
            let adherenciaTratamiento = calcularAdherenciaTratamiento(mensajesUsuario);
            
            // 3. Calcular tiempo hasta próxima revisión (basado en gravedad)
            let proximaRevision = calcularProximaRevision(textoCompleto);
            
            // Actualizar la UI con los valores calculados
            actualizarUIAnalitica(precisionDiagnostica, adherenciaTratamiento, proximaRevision);
        }
        
        // Calcular precisión diagnóstica
        function calcularPrecisionDiagnostica(mensajesMedico, textoCompleto) {
            // Base: precisión entre 70% y 98%
            let precision = 85;
            let cambio = 0;
            
            // Factores que aumentan la precisión
            const terminosMedicosAvanzados = [
                'diagnóstico diferencial', 'patología', 'etiología', 'pronóstico',
                'tratamiento basado en evidencia', 'fisiopatología', 'histopatología'
            ];
            
            // Factores que indican consistencia
            const indicadoresConsistencia = [
                'como mencioné anteriormente', 'según indicado', 'consistente con',
                'confirma el diagnóstico', 'concuerda con'
            ];
            
            // Contar términos médicos avanzados (cada uno suma hasta 2%)
            terminosMedicosAvanzados.forEach(termino => {
                if (textoCompleto.includes(termino)) {
                    precision += 1.5;
                }
            });
            
            // Contar indicadores de consistencia (cada uno suma hasta 1%)
            indicadoresConsistencia.forEach(indicador => {
                if (textoCompleto.includes(indicador)) {
                    precision += 1;
                }
            });
            
            // Evaluar la longitud de las respuestas (respuestas más largas suelen ser más precisas)
            const longitudPromedio = mensajesMedico.reduce((sum, msg) => sum + msg.length, 0) / 
                                    (mensajesMedico.length || 1);
            
            if (longitudPromedio > 300) precision += 3;
            else if (longitudPromedio > 200) precision += 1.5;
            
            // Inyectar variabilidad
            precision += (Math.random() * 2 - 1); // ±1%
            
            // Limitar entre 70% y 98%
            precision = Math.min(Math.max(precision, 70), 98);
            
            // Calcular cambio respecto a la vez anterior
            const precisionAnterior = parseFloat(localStorage.getItem('precisionAnterior') || precision);
            cambio = precision - precisionAnterior;
            localStorage.setItem('precisionAnterior', precision);
            
            return {
                valor: Math.round(precision),
                cambio: cambio.toFixed(1)
            };
        }
        
        // Calcular adherencia al tratamiento
        function calcularAdherenciaTratamiento(mensajesUsuario) {
            // Iniciar con 3/5
            let puntuacion = 3;
            
            // Palabras clave que indican adherencia
            const indicadoresAdherencia = [
                'tomo el medicamento', 'tomé', 'siguiendo tratamiento', 'tal como indicó',
                'según sus instrucciones', 'la dosis', 'los horarios'
            ];
            
            // Palabras clave que indican no adherencia
            const indicadoresNoAdherencia = [
                'olvidé', 'no lo tomé', 'dejé de', 'no puedo', 'efectos secundarios',
                'no me gusta', 'no funciona', 'paré', 'suspendí'
            ];
            
            // Contar menciones positivas (+0.5 cada una)
            indicadoresAdherencia.forEach(indicador => {
                for (const mensaje of mensajesUsuario) {
                    if (mensaje.includes(indicador)) {
                        puntuacion += 0.5;
                        break;
                    }
                }
            });
            
            // Contar menciones negativas (-0.5 cada una)
            indicadoresNoAdherencia.forEach(indicador => {
                for (const mensaje of mensajesUsuario) {
                    if (mensaje.includes(indicador)) {
                        puntuacion -= 0.5;
                        break;
                    }
                }
            });
            
            // Limitar entre 1 y 5
            puntuacion = Math.min(Math.max(Math.round(puntuacion), 1), 5);
            
            // Determinar cambio
            const adherenciaAnterior = parseInt(localStorage.getItem('adherenciaAnterior') || puntuacion);
            let cambioEstado = 'igual';
            
            if (puntuacion > adherenciaAnterior) {
                cambioEstado = 'mejora';
            } else if (puntuacion < adherenciaAnterior) {
                cambioEstado = 'empeora';
            }
            
            localStorage.setItem('adherenciaAnterior', puntuacion);
            
            return {
                valor: puntuacion,
                cambio: cambioEstado
            };
        }
        
        // Calcular tiempo hasta próxima revisión
        function calcularProximaRevision(textoCompleto) {
            // Por defecto, 14 días
            let dias = 14;
            
            // Factores que reducen el tiempo hasta la próxima visita
            const urgencia = {
                'emergencia': -13, // 1 día
                'urgente': -10, // 4 días
                'dolor intenso': -7, // 7 días
                'infección': -7,
                'fiebre alta': -10,
                'sangrado': -10,
                'vómito': -7,
                'diarrea': -5,
                'empeoramiento': -7
            };
            
            // Factores que aumentan el tiempo hasta la próxima visita
            const noUrgencia = {
                'mejorando': 7, // 21 días
                'estable': 7,
                'seguimiento rutinario': 16, // 30 días
                'control': 16,
                'leve': 6,
                'cronico': 16
            };
            
            // Buscar factores en el texto y ajustar días
            Object.entries(urgencia).forEach(([factor, ajuste]) => {
                if (textoCompleto.includes(factor)) {
                    dias += ajuste;
                }
            });
            
            Object.entries(noUrgencia).forEach(([factor, ajuste]) => {
                if (textoCompleto.includes(factor)) {
                    dias += ajuste;
                }
            });
            
            // Limitar entre 1 y 30 días
            dias = Math.min(Math.max(Math.round(dias), 1), 30);
            
            return {
                dias: dias
            };
        }
        
        // Actualizar la UI con los valores calculados
        function actualizarUIAnalitica(precision, adherencia, proximaRevision) {
            // 1. Actualizar precisión diagnóstica
            const precisionValor = document.querySelector('.medical-section-title + .row .col-md-4:nth-child(1) .h1 .badge');
            const precisionCambio = document.querySelector('.medical-section-title + .row .col-md-4:nth-child(1) .small');
            
            if (precisionValor) {
                precisionValor.textContent = precision.valor + '%';
            }
            
            if (precisionCambio) {
                let htmlCambio = '';
                if (parseFloat(precision.cambio) > 0) {
                    htmlCambio = `<i class="fas fa-arrow-up"></i> ${precision.cambio}% desde última consulta`;
                    precisionCambio.className = 'small text-success';
                } else if (parseFloat(precision.cambio) < 0) {
                    htmlCambio = `<i class="fas fa-arrow-down"></i> ${Math.abs(precision.cambio)}% desde última consulta`;
                    precisionCambio.className = 'small text-danger';
                } else {
                    htmlCambio = `<i class="fas fa-minus"></i> Sin cambios`;
                    precisionCambio.className = 'small text-warning';
                }
                precisionCambio.innerHTML = htmlCambio;
            }
            
            // 2. Actualizar adherencia al tratamiento
            const adherenciaValor = document.querySelector('.medical-section-title + .row .col-md-4:nth-child(2) .h1');
            const adherenciaCambio = document.querySelector('.medical-section-title + .row .col-md-4:nth-child(2) .small');
            
            if (adherenciaValor) {
                adherenciaValor.innerHTML = `<span class="text-success">${adherencia.valor}</span>/<span class="text-muted">5</span>`;
            }
            
            if (adherenciaCambio) {
                let htmlCambio = '';
                if (adherencia.cambio === 'mejora') {
                    htmlCambio = '<i class="fas fa-arrow-up"></i> Mejorando';
                    adherenciaCambio.className = 'small text-success';
                } else if (adherencia.cambio === 'empeora') {
                    htmlCambio = '<i class="fas fa-arrow-down"></i> Disminuyendo';
                    adherenciaCambio.className = 'small text-danger';
                } else {
                    htmlCambio = '<i class="fas fa-minus"></i> Sin cambios';
                    adherenciaCambio.className = 'small text-warning';
                }
                adherenciaCambio.innerHTML = htmlCambio;
            }
            
            // 3. Actualizar próxima revisión
            const revisionValor = document.querySelector('.medical-section-title + .row .col-md-4:nth-child(3) .small');
            
            if (revisionValor) {
                revisionValor.textContent = `En ${proximaRevision.dias} días`;
            }
        }
        
        // Manejador de telemedicina
        document.getElementById('telemedicine-btn')?.addEventListener('click', function() {
            if (telemedicineModal) {
                telemedicineModal.show();
            }
        });
        
        // Manejadores para botones de entrada por voz e imagen
        document.getElementById('voice-input-btn')?.addEventListener('click', function() {
            alert('Funcionalidad de entrada por voz en desarrollo');
        });
        
        document.getElementById('upload-image-btn')?.addEventListener('click', function() {
            alert('Funcionalidad de carga de imágenes médicas en desarrollo');
        });
        
        // Inicializar la página
        const messagesContainer = document.getElementById('chat-messages');
        if (messagesContainer) {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            // Realizar evaluación inicial de triaje
            evaluarTriaje();
            // Inicializar analítica IA
            actualizarAnaliticaIA();
        }
        
        // Simular actualización de signos vitales
        function updateVitalSigns() {
            const vitalValues = document.querySelectorAll('.vital-value');
            if (vitalValues.length > 0) {
                // Temperatura: variar entre 36.5 y 36.9
                vitalValues[0].textContent = (36.5 + Math.random() * 0.4).toFixed(1) + '°C';
                
                // Ritmo cardíaco: variar entre 70 y 75
                vitalValues[1].textContent = Math.floor(70 + Math.random() * 5) + ' bpm';
                
                // Respiración: variar entre 15 y 17
                vitalValues[2].textContent = Math.floor(15 + Math.random() * 2) + ' rpm';
                
                // Presión arterial: ligeras variaciones
                const systolic = Math.floor(119 + Math.random() * 3);
                const diastolic = Math.floor(79 + Math.random() * 3);
                vitalValues[3].textContent = systolic + '/' + diastolic;
            }
            
            // Programar próxima actualización
            setTimeout(updateVitalSigns, 5000);
        }
        
        // Iniciar simulación de signos vitales
        updateVitalSigns();
        
        // Función para añadir un mensaje al chat (mantener esta para el funcionamiento)
        function addMessage(content, sender, timestamp) {
            const messagesContainer = document.getElementById('chat-messages');
            const template = document.getElementById('message-template');
            const messageNode = template.content.cloneNode(true);
            
            // Configurar clase y estilos según el remitente
            const messageDiv = messageNode.querySelector('.message');
            const messageContent = messageNode.querySelector('.message-content');
            const messageText = messageNode.querySelector('.message-text');
            const messageSender = messageNode.querySelector('.message-sender');
            const messageTime = messageNode.querySelector('.message-time');
            
            // Configurar el contenido y metadatos
            messageText.textContent = content;
            messageTime.textContent = ' - ' + new Date(timestamp).toLocaleString();
            
            if (sender === 'user') {
                messageDiv.classList.add('text-end');
                messageContent.classList.add('patient-message', 'float-end');
                messageSender.innerHTML = '<i class="fas fa-user"></i> Paciente';
            } else if (sender === 'system') {
                messageContent.classList.add('system-message');
                messageSender.innerHTML = '<i class="fas fa-cog"></i> Sistema';
            } else {
                messageContent.classList.add('doctor-message');
                messageSender.innerHTML = '<i class="fas fa-user-md"></i> Dr. ' + sender.charAt(0).toUpperCase() + sender.slice(1);
            }
            
            // Añadir mensaje al contenedor
            messagesContainer.appendChild(messageNode);
            
            // Desplazarse al último mensaje
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Reevaluar triaje después de añadir un mensaje
            setTimeout(evaluarTriaje, 500);
        }
        
        // Manejar envío de mensajes
        document.getElementById('message-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const messageInput = document.getElementById('message-input');
            const message = messageInput.value.trim();
            
            if (!message) return;
            
            // Añadir mensaje del usuario al chat (presentación inmediata)
            addMessage(message, 'user', new Date().toISOString());
            
            // Limpiar el campo de entrada
            messageInput.value = '';
            
            try {
                // Mostrar indicador de escritura
                const typingIndicator = document.createElement('div');
                typingIndicator.className = 'message-typing mb-2';
                typingIndicator.innerHTML = '<div class="message-content p-2 rounded bg-light" style="max-width: 80%; display: inline-block;">Escribiendo...</div>';
                document.getElementById('chat-messages').appendChild(typingIndicator);
                
                // Enviar mensaje al servidor
                const formData = new FormData();
                formData.append('message', message);
                
                const response = await fetch('{{ url_for("interactive.send_message") }}', {
                    method: 'POST',
                    body: formData
                });
                
                // Eliminar indicador de escritura
                document.getElementById('chat-messages').removeChild(typingIndicator);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success && data.conversation) {
                        // Obtener el último mensaje del especialista
                        const messages = data.conversation.messages;
                        const lastMessage = messages[messages.length - 1];
                        
                        // Actualizar el especialista actual si ha cambiado
                        const newSpecialty = data.conversation.active_specialty;
                        if (newSpecialty && document.getElementById('active-specialty').textContent.toLowerCase() !== newSpecialty) {
                            document.getElementById('active-specialty').textContent = newSpecialty.charAt(0).toUpperCase() + newSpecialty.slice(1);
                            document.getElementById('header-specialty').textContent = newSpecialty.charAt(0).toUpperCase() + newSpecialty.slice(1);
                        }
                        
                        if (lastMessage && lastMessage.sender !== 'user') {
                            // Añadir respuesta del especialista al chat
                            addMessage(lastMessage.content, lastMessage.sender, lastMessage.timestamp);
                        }
                        
                        // Actualizar el triaje con el nuevo contenido
                        evaluarTriaje();
                        // Actualizar analítica IA
                        actualizarAnaliticaIA();
                    } else {
                        // Mostrar mensaje de error
                        addMessage(data.error || 'Error al procesar el mensaje', 'system', new Date().toISOString());
                    }
                } else {
                    // Mostrar mensaje de error
                    addMessage('Error de comunicación con el servidor', 'system', new Date().toISOString());
                }
            } catch (error) {
                console.error('Error:', error);
                addMessage('Error de comunicación con el servidor', 'system', new Date().toISOString());
            }
        });
        
        // Resto del código existente...
    });
</script>
{% endblock %} 