{% extends "base.html" %}

{% block title %}Consulta Médica Virtual - Especialistas Médicos{% endblock %}

{% block extra_css %}
<style>
    /* Estilos específicos para esta página */
    .medical-icon {
        color: var(--primary-color);
        margin-right: 8px;
    }
    
    .patient-info {
        background-color: #f8fafc;
        border-left: 4px solid var(--primary-color);
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 0 5px 5px 0;
    }
    
    .specialty-tag {
        display: inline-block;
        padding: 3px 8px;
        margin: 2px;
        border-radius: 4px;
        font-size: 0.8rem;
        color: white;
        background-color: var(--primary-color);
    }
    
    .medical-section-title {
        color: var(--primary-color);
        font-weight: 600;
        border-bottom: 1px solid #e0e0e0;
        padding-bottom: 5px;
        margin-bottom: 15px;
    }
    
    .vital-sign-badge {
        display: inline-flex;
        align-items: center;
        margin-right: 15px;
        padding: 5px 10px;
        background-color: #f5f8fa;
        border-radius: 50px;
        font-size: 0.9rem;
    }
    
    .consultation-header {
        background-color: var(--primary-color);
        color: white;
        padding: 15px;
        border-radius: 8px 8px 0 0;
        margin-bottom: 0;
    }
    
    .chat-container {
        background-color: white;
        border: 1px solid #e0e0e0;
        border-top: none;
        border-radius: 0 0 8px 8px;
        padding: 20px;
    }
    
    .doctor-message {
        background-color: #f0f7ff;
        border-left: 3px solid var(--primary-color);
    }
    
    .system-message {
        background-color: #f9f9f9;
        border-left: 3px solid #888;
    }
    
    .patient-message {
        background-color: #f0fff5;
        border-left: 3px solid var(--secondary-color);
    }
    
    .triage-form {
        background-color: #f8f9fa;
        border-left: 4px solid var(--primary-color);
        padding: 20px;
        margin-bottom: 30px;
        border-radius: 5px;
    }
    
    .triage-header {
        color: var(--primary-color);
        font-weight: 600;
        margin-bottom: 15px;
    }
    
    .medical-resource-item {
        transition: all 0.3s ease;
    }
    
    .medical-resource-item:hover {
        background-color: #f8f9fa;
        border-left: 3px solid var(--primary-color);
        transform: translateX(2px);
    }
    
    .medical-resource-item .badge {
        transition: all 0.3s ease;
    }
    
    .medical-resource-item:hover .badge {
        transform: scale(1.1);
    }
    
    /* Estilos para el timeline de consultas */
    .timeline {
        position: relative;
        padding: 20px 0;
    }
    
    .timeline-item {
        position: relative;
        margin-bottom: 30px;
        padding-left: 60px;
    }
    
    .timeline-item:before {
        content: '';
        position: absolute;
        left: 20px;
        top: 0;
        bottom: -30px;
        width: 2px;
        background: #e9ecef;
    }
    
    .timeline-item:last-child:before {
        display: none;
    }
    
    .timeline-marker {
        position: absolute;
        left: 8px;
        top: 8px;
        width: 24px;
        height: 24px;
        background: var(--primary-color);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 12px;
        z-index: 1;
    }
    
    .timeline-item.active .timeline-marker {
        background: var(--secondary-color);
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
        100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Initial Triage Form - Only shown for new conversations -->
    {% if not conversation.messages or conversation.messages|length <= 1 %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="triage-form">
                <h4 class="triage-header">
                    <i class="fas fa-stethoscope"></i> Sistema de Triaje Médico
                </h4>
                <p class="text-muted">
                    Por favor, describa sus síntomas o motivo de consulta para que podamos asignarle el especialista más adecuado.
                </p>
                <form method="POST" action="{{ url_for('interactive.interactive_chat_home') }}">
                    <div class="mb-3">
                        <textarea class="form-control" name="initial_symptoms" rows="3" 
                            placeholder="Ej: Dolor de cabeza intenso desde hace 3 días, sensibilidad a la luz y náuseas ocasionales..." required></textarea>
                    </div>
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-user-md"></i> Iniciar Consulta con Especialista
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Banner de Hospital IA -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="alert alert-info d-flex align-items-center">
                <i class="fas fa-robot me-3 fa-2x"></i>
                <div>
                    <strong>Hospital AI Salud</strong> - Sistema de atención médica inteligente
                    <div class="small">Análisis en tiempo real • Diagnósticos avanzados • Atención personalizada</div>
                </div>
                <div class="ms-auto">
                    <span class="badge bg-success">
                        <i class="fas fa-check-circle"></i> Sistemas conectados
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Cabecera de consulta médica -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="clinical-section">
                <div class="d-flex justify-content-between align-items-center">
                    <h3 class="clinical-header mb-0">
                        <i class="fas fa-hospital-user medical-icon"></i>Consulta Médica Virtual
                    </h3>
                    <span class="badge bg-primary">ID: {{ conversation.conversation_id }}</span>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="medical-record-section">
                            <div class="medical-category">Datos de la consulta</div>
                            <p class="mb-1"><i class="fas fa-calendar-alt medical-icon"></i>Fecha: {{ now().strftime('%d/%m/%Y') }}</p>
                            <p class="mb-1"><i class="fas fa-clock medical-icon"></i>Hora: {{ now().strftime('%H:%M') }}</p>
                            <p class="mb-0"><i class="fas fa-user-md medical-icon"></i>Especialista: 
                                <span class="badge bg-success" id="active-specialty">{{ conversation.active_specialty | capitalize }}</span>
                            </p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="medical-record-section">
                            <div class="medical-category">Panel de especialistas</div>
                            <div>
                                {% for specialty in conversation.all_specialties %}
                                <span class="specialty-tag">
                                    {{ specialty | capitalize }}
                                    {% if specialty == conversation.active_specialty %}
                                    <i class="fas fa-check-circle ms-1"></i>
                                    {% endif %}
                                </span>
                                {% endfor %}
                            </div>
                            <small class="text-muted mt-2 d-block">
                                El sistema deriva automáticamente al especialista adecuado
                            </small>
                        </div>
                    </div>
                </div>
                
                <!-- Sistema de triaje IA -->
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="alert alert-light border d-flex align-items-center p-2">
                            <div class="d-flex align-items-center text-primary">
                                <i class="fas fa-heartbeat me-2"></i>
                                <strong>Triaje IA:</strong>
                            </div>
                            <div class="progress ms-3 flex-grow-1" style="height: 10px;">
                                <div class="progress-bar bg-success" role="progressbar" style="width: 75%" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <span class="badge bg-success ms-2">Prioridad normal</span>
                            <button class="btn btn-sm btn-outline-primary ms-3" data-bs-toggle="tooltip" title="Actualizado cada 5 minutos basado en sus síntomas">
                                <i class="fas fa-info-circle"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- Panel lateral con herramientas médicas -->
        <div class="col-md-3">
            <!-- Panel de monitoreo de signos vitales -->
            <div class="clinical-section mb-4">
                <h5 class="medical-section-title">
                    <i class="fas fa-heartbeat medical-icon"></i>Monitoreo IA
                    <span class="badge bg-success float-end" style="font-size: 0.6rem;">EN VIVO</span>
                </h5>
                
                <div class="vital-sign">
                    <i class="fas fa-temperature-high vital-icon"></i>
                    <div class="flex-grow-1">Temperatura</div>
                    <div class="vital-value">36.7°C</div>
                </div>
                
                <div class="vital-sign">
                    <i class="fas fa-heart vital-icon"></i>
                    <div class="flex-grow-1">Ritmo cardíaco</div>
                    <div class="vital-value">72 bpm</div>
                </div>
                
                <div class="vital-sign">
                    <i class="fas fa-lungs vital-icon"></i>
                    <div class="flex-grow-1">Respiración</div>
                    <div class="vital-value">16 rpm</div>
                </div>
                
                <div class="vital-sign">
                    <i class="fas fa-tint vital-icon"></i>
                    <div class="flex-grow-1">Presión arterial</div>
                    <div class="vital-value">120/80</div>
                </div>
                
                <div class="mt-3 text-center">
                    <span class="small text-muted">
                        <i class="fas fa-sync-alt"></i> Datos simulados con fines demostrativos
                    </span>
                </div>
            </div>
            
            <!-- Panel de historial y acciones médicas -->
            <div class="clinical-section mb-4">
                <h5 class="medical-section-title">
                    <i class="fas fa-clipboard-list medical-icon"></i>Historial médico
                </h5>
                <p class="text-muted small">Esta consulta contiene información relevante para su historial médico</p>
                <hr>
                <div class="d-grid gap-2">
                    <button id="generate-report-btn" class="btn btn-success w-100">
                        <i class="fas fa-file-medical"></i> Generar informe médico
                    </button>
                    <a href="{{ url_for('interactive.interactive_chat_home', new=1) }}" class="btn btn-danger">
                        <i class="fas fa-plus-circle"></i> Nueva consulta
                    </a>
                    
                    <!-- Opción de telemedicina -->
                    <button class="btn btn-primary w-100" id="telemedicine-btn">
                        <i class="fas fa-video"></i> Solicitar videoconsulta
                    </button>
                </div>
            </div>
            
            <!-- Panel de recursos médicos -->
            <div class="clinical-section">
                <h5 class="medical-section-title">
                    <i class="fas fa-book-medical medical-icon"></i>Recursos médicos
                </h5>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex align-items-center justify-content-between medical-resource-item" 
                        data-resource="medications" style="cursor: pointer;" 
                        data-bs-toggle="tooltip" title="Ver medicamentos recetados en esta consulta">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-pills medical-icon"></i>
                            <span>Medicamentos recetados</span>
                        </div>
                        <span class="badge bg-primary" id="medications-count">0</span>
                    </li>
                    <li class="list-group-item d-flex align-items-center justify-content-between medical-resource-item" 
                        data-resource="consultations" style="cursor: pointer;"
                        data-bs-toggle="tooltip" title="Ver historial completo de consultas">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-notes-medical medical-icon"></i>
                            <span>Historial de consultas</span>
                        </div>
                        <span class="badge bg-success" id="consultations-count">0</span>
                    </li>
                    <li class="list-group-item d-flex align-items-center justify-content-between medical-resource-item" 
                        data-resource="lab-results" style="cursor: pointer;"
                        data-bs-toggle="tooltip" title="Ver resultados de exámenes de laboratorio">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-vial medical-icon"></i>
                            <span>Resultados de laboratorio</span>
                        </div>
                        <span class="badge bg-warning" id="lab-results-count">0</span>
                    </li>
                    <li class="list-group-item d-flex align-items-center justify-content-between medical-resource-item" 
                        data-resource="diagnostic-images" style="cursor: pointer;"
                        data-bs-toggle="tooltip" title="Ver imágenes diagnósticas de esta consulta">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-x-ray medical-icon"></i>
                            <span>Imágenes diagnósticas</span>
                        </div>
                        <span class="badge bg-info" id="diagnostic-images-count">0</span>
                    </li>
                </ul>
                <div class="text-center mt-3">
                    <a href="{{ url_for('web.index') }}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-home"></i> Volver al inicio
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Panel principal con la consulta médica -->
        <div class="col-md-9">
            <!-- Dashboard de analítica médica -->
            <div class="clinical-section mb-4">
                <h5 class="medical-section-title">
                    <i class="fas fa-chart-line medical-icon"></i>Analítica IA
                    <button class="btn btn-sm btn-outline-primary float-end">
                        <i class="fas fa-expand-alt"></i> Ampliar
                    </button>
                </h5>
                <div class="row">
                    <div class="col-md-4">
                        <div class="card border-0 bg-light">
                            <div class="card-body text-center">
                                <div class="h1 mb-3">
                                    <span class="badge rounded-pill bg-primary">92%</span>
                                </div>
                                <h6 class="text-muted">Precisión diagnóstica</h6>
                                <div class="small text-success">
                                    <i class="fas fa-arrow-up"></i> 3% desde última consulta
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-0 bg-light">
                            <div class="card-body text-center">
                                <div class="h1 mb-3">
                                    <span class="text-success">4</span>/<span class="text-muted">5</span>
                                </div>
                                <h6 class="text-muted">Adherencia a tratamiento</h6>
                                <div class="small text-warning">
                                    <i class="fas fa-minus"></i> Sin cambios
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-0 bg-light">
                            <div class="card-body text-center">
                                <div class="h1 mb-3 text-primary">
                                    <i class="fas fa-calendar-check"></i>
                                </div>
                                <h6 class="text-muted">Próxima revisión</h6>
                                <div class="small">En 14 días</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="text-center mt-3">
                    <span class="badge bg-light text-muted">Los datos se analizan en tiempo real</span>
                </div>
            </div>
        
            <h4 class="consultation-header d-flex justify-content-between align-items-center">
                <span>
                    <i class="fas fa-comment-medical"></i> 
                    Consulta con Dr. <span id="header-specialty">{{ conversation.active_specialty | capitalize }}</span>
                </span>
                <span class="badge bg-light text-dark">En curso</span>
            </h4>
            
            <div class="chat-container">
                <!-- Historial de la conversación médica -->
                <div id="chat-messages" class="mb-4" style="height: 350px; overflow-y: auto;">
                    {% for message in conversation.messages %}
                    <div class="message mb-3 {% if message.sender == 'user' %}text-end{% endif %}">
                        <div class="message-content p-3 rounded 
                            {% if message.sender == 'user' %}
                                patient-message float-end
                            {% elif message.sender == 'system' %}
                                system-message
                            {% else %}
                                doctor-message
                            {% endif %}
                            " style="max-width: 85%; display: inline-block;">
                            {{ message.content }}
                        </div>
                        <div class="clearfix"></div>
                        <small class="text-muted {% if message.sender == 'user' %}text-end{% endif %} d-block mt-1">
                            {% if message.sender == 'user' %}
                                <i class="fas fa-user"></i> Paciente
                            {% elif message.sender == 'system' %}
                                <i class="fas fa-cog"></i> Sistema
                            {% else %}
                                <i class="fas fa-user-md"></i> Dr. {{ message.sender | capitalize }}
                            {% endif %}
                            - {{ message.timestamp | replace('T', ' ') | replace('Z', '') }}
                        </small>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Formulario para enviar mensajes médicos -->
                <div class="clinical-section" style="margin-bottom:0;">
                    <form id="message-form">
                        <div class="input-group">
                            <span class="input-group-text bg-light">
                                <i class="fas fa-user text-primary"></i>
                            </span>
                            <input type="text" id="message-input" name="message" class="form-control" 
                                placeholder="Describa sus síntomas o haga una pregunta médica..." required />
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane"></i> Enviar
                            </button>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i> 
                                Sea específico acerca de sus síntomas para recibir una mejor atención médica
                            </small>
                            
                            <div class="btn-group">
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="voice-input-btn">
                                    <i class="fas fa-microphone"></i> Voz
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="upload-image-btn">
                                    <i class="fas fa-camera"></i> Imagen
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para mostrar el informe médico con estilo clínico -->
<div class="modal fade" id="report-modal" tabindex="-1" aria-labelledby="report-modal-label" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="report-modal-label">
            <i class="fas fa-file-medical"></i> Informe Médico Oficial
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div id="report-loading" class="text-center p-4">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Generando informe...</span>
          </div>
          <p class="mt-3">Generando informe médico completo, por favor espere...</p>
        </div>
        <div id="report-content" class="d-none">
          <!-- El contenido del informe se insertará aquí -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times"></i> Cerrar
        </button>
        <button type="button" class="btn btn-primary" id="download-report-btn">
            <i class="fas fa-download"></i> Descargar PDF
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de telemedicina -->
<div class="modal fade" id="telemedicine-modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">
            <i class="fas fa-video"></i> Videoconsulta IA
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body text-center">
        <div class="p-3">
            <i class="fas fa-robot text-primary" style="font-size: 4rem;"></i>
            <h4 class="mt-3">Consulta por videollamada</h4>
            <p class="text-muted">Un médico especialista asistido por IA le atenderá en directo</p>
            
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> 
                Próxima disponibilidad: <strong>10 minutos</strong>
            </div>
            
            <form>
                <div class="mb-3">
                    <label class="form-label">Seleccione especialista:</label>
                    <select class="form-select">
                        <option>Dr. IA {{ conversation.active_specialty | capitalize }} (Inmediato)</option>
                        <option>Dr. López - {{ conversation.active_specialty | capitalize }} (30 min)</option>
                        <option>Dra. Gómez - {{ conversation.active_specialty | capitalize }} (45 min)</option>
                    </select>
                </div>
            </form>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary">Programar videoconsulta</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para Medicamentos Recetados -->
<div class="modal fade" id="medications-modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">
            <i class="fas fa-pills"></i> Medicamentos Recetados
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div id="medications-loading" class="text-center p-4">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando medicamentos...</span>
          </div>
        </div>
        <div id="medications-content" class="d-none">
          <!-- Contenido de medicamentos se insertará aquí -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button type="button" class="btn btn-primary" id="export-medications-btn">
            <i class="fas fa-download"></i> Exportar Lista
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para Historial de Consultas -->
<div class="modal fade" id="consultations-modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">
            <i class="fas fa-notes-medical"></i> Historial de Consultas
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div id="consultations-loading" class="text-center p-4">
          <div class="spinner-border text-success" role="status">
            <span class="visually-hidden">Cargando historial...</span>
          </div>
        </div>
        <div id="consultations-content" class="d-none">
          <!-- Contenido del historial se insertará aquí -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button type="button" class="btn btn-success" id="export-consultations-btn">
            <i class="fas fa-file-export"></i> Exportar Historial
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para Resultados de Laboratorio -->
<div class="modal fade" id="lab-results-modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title">
            <i class="fas fa-vial"></i> Resultados de Laboratorio
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div id="lab-results-loading" class="text-center p-4">
          <div class="spinner-border text-warning" role="status">
            <span class="visually-hidden">Cargando resultados...</span>
          </div>
        </div>
        <div id="lab-results-content" class="d-none">
          <!-- Contenido de resultados se insertará aquí -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button type="button" class="btn btn-warning" id="export-lab-results-btn">
            <i class="fas fa-chart-line"></i> Exportar Resultados
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para Imágenes Diagnósticas -->
<div class="modal fade" id="diagnostic-images-modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title">
            <i class="fas fa-x-ray"></i> Imágenes Diagnósticas
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div id="diagnostic-images-loading" class="text-center p-4">
          <div class="spinner-border text-info" role="status">
            <span class="visually-hidden">Cargando imágenes...</span>
          </div>
        </div>
        <div id="diagnostic-images-content" class="d-none">
          <!-- Contenido de imágenes se insertará aquí -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button type="button" class="btn btn-info" id="export-images-btn">
            <i class="fas fa-download"></i> Descargar Imágenes
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Plantilla para nuevos mensajes -->
<template id="message-template">
    <div class="message mb-3">
        <div class="message-content p-3 rounded" style="max-width: 85%; display: inline-block;">
            <span class="message-text"></span>
        </div>
        <div class="clearfix"></div>
        <small class="text-muted d-block mt-1">
            <span class="message-sender"></span>
            <span class="message-time"></span>
        </small>
    </div>
</template>

{% endblock %}

{% block extra_js %}
<script>
    // Cuando el DOM esté listo
    document.addEventListener('DOMContentLoaded', function() {
        console.log("DOM cargado, inicializando componentes...");
        
        // Inicializar el modal de Bootstrap
        var reportModal;
        var telemedicineModal;
        
        try {
            var reportModalEl = document.getElementById('report-modal');
            var telemedicineModalEl = document.getElementById('telemedicine-modal');
            
            if (reportModalEl) {
                reportModal = new bootstrap.Modal(reportModalEl);
            }
            
            if (telemedicineModalEl) {
                telemedicineModal = new bootstrap.Modal(telemedicineModalEl);
            }
            
            // Inicializar tooltips de Bootstrap
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
            });
            
            console.log("Componentes inicializados correctamente");
        } catch (err) {
            console.error("Error inicializando componentes:", err);
        }
        
        // Sistema de triaje automático basado en IA
        function evaluarTriaje() {
            // Palabras clave que indican diferentes niveles de prioridad
            const palabrasEmergencia = ['sangrado abundante', 'dificultad para respirar', 'dolor intenso', 'desmayo', 
                'inconsciente', 'ataque', 'convulsión', 'infarto', 'accidente', 'traumatismo', 'no responde',
                'sangra', 'no puedo respirar', 'asfixia', 'ahogo', 'fiebre alta', 'vómito con sangre'];
            
            const palabrasUrgente = ['dolor', 'fiebre', 'vómito', 'diarrea', 'mareo', 'dolor de cabeza', 
                'migraña', 'náuseas', 'lesión', 'fractura', 'deshidratación', 'infección', 'alergia grave'];
            
            const palabrasNormal = ['consulta', 'seguimiento', 'revisión', 'medicamento', 'receta', 'información',
                'leve', 'moderado', 'mejorando', 'crónico', 'rutina', 'control'];
            
            // Obtener mensajes del chat
            const mensajes = document.querySelectorAll('.message-content');
            let textoCompleto = '';
            
            // Concatenar todos los mensajes para analizar
            mensajes.forEach(mensaje => {
                textoCompleto += ' ' + mensaje.textContent.toLowerCase();
            });
            
            // Contar coincidencias para cada nivel de prioridad
            let contadorEmergencia = 0;
            let contadorUrgente = 0;
            let contadorNormal = 0;
            
            // Buscar palabras de emergencia
            palabrasEmergencia.forEach(palabra => {
                if (textoCompleto.includes(palabra.toLowerCase())) {
                    contadorEmergencia += 1;
                }
            });
            
            // Buscar palabras urgentes
            palabrasUrgente.forEach(palabra => {
                if (textoCompleto.includes(palabra.toLowerCase())) {
                    contadorUrgente += 1;
                }
            });
            
            // Buscar palabras normales
            palabrasNormal.forEach(palabra => {
                if (textoCompleto.includes(palabra.toLowerCase())) {
                    contadorNormal += 1;
                }
            });
            
            // Determinar la prioridad basada en los contadores
            let prioridad, porcentaje, colorBarra;
            
            if (contadorEmergencia >= 2) {
                prioridad = "Emergencia";
                porcentaje = 95;
                colorBarra = "bg-danger";
            } else if (contadorEmergencia == 1 || contadorUrgente >= 3) {
                prioridad = "Urgente";
                porcentaje = 85;
                colorBarra = "bg-warning";
            } else if (contadorUrgente >= 1) {
                prioridad = "Prioritario";
                porcentaje = 70;
                colorBarra = "bg-primary";
            } else {
                prioridad = "Normal";
                porcentaje = 50;
                colorBarra = "bg-success";
            }
            
            // Actualizar la UI con los resultados
            const progressBar = document.querySelector('.progress-bar');
            const priorityBadge = document.querySelector('.progress').nextElementSibling;
            
            if (progressBar) {
                progressBar.style.width = porcentaje + '%';
                progressBar.setAttribute('aria-valuenow', porcentaje);
                progressBar.className = 'progress-bar ' + colorBarra;
            }
            
            if (priorityBadge) {
                priorityBadge.textContent = 'Prioridad: ' + prioridad;
                priorityBadge.className = 'badge ms-2 ' + colorBarra;
            }
            
            console.log(`Triaje IA: Prioridad ${prioridad} (${porcentaje}%) - E:${contadorEmergencia} U:${contadorUrgente} N:${contadorNormal}`);
            return { prioridad, porcentaje, colorBarra };
        }
        
        // Sistema de analítica IA - Calcula métricas basadas en la conversación
        function actualizarAnaliticaIA() {
            // Obtener todos los mensajes del chat
            const mensajes = document.querySelectorAll('.message-content');
            let textoCompleto = '';
            let mensajesUsuario = [];
            let mensajesMedico = [];
            
            // Separar mensajes por remitente
            mensajes.forEach(mensaje => {
                const contenido = mensaje.textContent.toLowerCase();
                textoCompleto += ' ' + contenido;
                
                // Determinar si es mensaje de usuario o médico
                if (mensaje.classList.contains('patient-message')) {
                    mensajesUsuario.push(contenido);
                } else if (mensaje.classList.contains('doctor-message')) {
                    mensajesMedico.push(contenido);
                }
            });
            
            // 1. Calcular precisión diagnóstica (basada en coherencia de respuestas del médico)
            let precisionDiagnostica = calcularPrecisionDiagnostica(mensajesMedico, textoCompleto);
            
            // 2. Calcular adherencia al tratamiento (basada en respuestas del paciente)
            let adherenciaTratamiento = calcularAdherenciaTratamiento(mensajesUsuario);
            
            // 3. Calcular tiempo hasta próxima revisión (basado en gravedad)
            let proximaRevision = calcularProximaRevision(textoCompleto);
            
            // Actualizar la UI con los valores calculados
            actualizarUIAnalitica(precisionDiagnostica, adherenciaTratamiento, proximaRevision);
        }
        
        // Calcular precisión diagnóstica
        function calcularPrecisionDiagnostica(mensajesMedico, textoCompleto) {
            // Base: precisión entre 70% y 98%
            let precision = 85;
            let cambio = 0;
            
            // Factores que aumentan la precisión
            const terminosMedicosAvanzados = [
                'diagnóstico diferencial', 'patología', 'etiología', 'pronóstico',
                'tratamiento basado en evidencia', 'fisiopatología', 'histopatología'
            ];
            
            // Factores que indican consistencia
            const indicadoresConsistencia = [
                'como mencioné anteriormente', 'según indicado', 'consistente con',
                'confirma el diagnóstico', 'concuerda con'
            ];
            
            // Contar términos médicos avanzados (cada uno suma hasta 2%)
            terminosMedicosAvanzados.forEach(termino => {
                if (textoCompleto.includes(termino)) {
                    precision += 1.5;
                }
            });
            
            // Contar indicadores de consistencia (cada uno suma hasta 1%)
            indicadoresConsistencia.forEach(indicador => {
                if (textoCompleto.includes(indicador)) {
                    precision += 1;
                }
            });
            
            // Evaluar la longitud de las respuestas (respuestas más largas suelen ser más precisas)
            const longitudPromedio = mensajesMedico.reduce((sum, msg) => sum + msg.length, 0) / 
                                    (mensajesMedico.length || 1);
            
            if (longitudPromedio > 300) precision += 3;
            else if (longitudPromedio > 200) precision += 1.5;
            
            // Inyectar variabilidad
            precision += (Math.random() * 2 - 1); // ±1%
            
            // Limitar entre 70% y 98%
            precision = Math.min(Math.max(precision, 70), 98);
            
            // Calcular cambio respecto a la vez anterior
            const precisionAnterior = parseFloat(localStorage.getItem('precisionAnterior') || precision);
            cambio = precision - precisionAnterior;
            localStorage.setItem('precisionAnterior', precision);
            
            return {
                valor: Math.round(precision),
                cambio: cambio.toFixed(1)
            };
        }
        
        // Calcular adherencia al tratamiento
        function calcularAdherenciaTratamiento(mensajesUsuario) {
            // Iniciar con 3/5
            let puntuacion = 3;
            
            // Palabras clave que indican adherencia
            const indicadoresAdherencia = [
                'tomo el medicamento', 'tomé', 'siguiendo tratamiento', 'tal como indicó',
                'según sus instrucciones', 'la dosis', 'los horarios'
            ];
            
            // Palabras clave que indican no adherencia
            const indicadoresNoAdherencia = [
                'olvidé', 'no lo tomé', 'dejé de', 'no puedo', 'efectos secundarios',
                'no me gusta', 'no funciona', 'paré', 'suspendí'
            ];
            
            // Contar menciones positivas (+0.5 cada una)
            indicadoresAdherencia.forEach(indicador => {
                for (const mensaje of mensajesUsuario) {
                    if (mensaje.includes(indicador)) {
                        puntuacion += 0.5;
                        break;
                    }
                }
            });
            
            // Contar menciones negativas (-0.5 cada una)
            indicadoresNoAdherencia.forEach(indicador => {
                for (const mensaje of mensajesUsuario) {
                    if (mensaje.includes(indicador)) {
                        puntuacion -= 0.5;
                        break;
                    }
                }
            });
            
            // Limitar entre 1 y 5
            puntuacion = Math.min(Math.max(Math.round(puntuacion), 1), 5);
            
            // Determinar cambio
            const adherenciaAnterior = parseInt(localStorage.getItem('adherenciaAnterior') || puntuacion);
            let cambioEstado = 'igual';
            
            if (puntuacion > adherenciaAnterior) {
                cambioEstado = 'mejora';
            } else if (puntuacion < adherenciaAnterior) {
                cambioEstado = 'empeora';
            }
            
            localStorage.setItem('adherenciaAnterior', puntuacion);
            
            return {
                valor: puntuacion,
                cambio: cambioEstado
            };
        }
        
        // Calcular tiempo hasta próxima revisión
        function calcularProximaRevision(textoCompleto) {
            // Por defecto, 14 días
            let dias = 14;
            
            // Factores que reducen el tiempo hasta la próxima visita
            const urgencia = {
                'emergencia': -13, // 1 día
                'urgente': -10, // 4 días
                'dolor intenso': -7, // 7 días
                'infección': -7,
                'fiebre alta': -10,
                'sangrado': -10,
                'vómito': -7,
                'diarrea': -5,
                'empeoramiento': -7
            };
            
            // Factores que aumentan el tiempo hasta la próxima visita
            const noUrgencia = {
                'mejorando': 7, // 21 días
                'estable': 7,
                'seguimiento rutinario': 16, // 30 días
                'control': 16,
                'leve': 6,
                'cronico': 16
            };
            
            // Buscar factores en el texto y ajustar días
            Object.entries(urgencia).forEach(([factor, ajuste]) => {
                if (textoCompleto.includes(factor)) {
                    dias += ajuste;
                }
            });
            
            Object.entries(noUrgencia).forEach(([factor, ajuste]) => {
                if (textoCompleto.includes(factor)) {
                    dias += ajuste;
                }
            });
            
            // Limitar entre 1 y 30 días
            dias = Math.min(Math.max(Math.round(dias), 1), 30);
            
            return {
                dias: dias
            };
        }
        
        // Actualizar la UI con los valores calculados
        function actualizarUIAnalitica(precision, adherencia, proximaRevision) {
            // 1. Actualizar precisión diagnóstica
            const precisionValor = document.querySelector('.medical-section-title + .row .col-md-4:nth-child(1) .h1 .badge');
            const precisionCambio = document.querySelector('.medical-section-title + .row .col-md-4:nth-child(1) .small');
            
            if (precisionValor) {
                precisionValor.textContent = precision.valor + '%';
            }
            
            if (precisionCambio) {
                let htmlCambio = '';
                if (parseFloat(precision.cambio) > 0) {
                    htmlCambio = `<i class="fas fa-arrow-up"></i> ${precision.cambio}% desde última consulta`;
                    precisionCambio.className = 'small text-success';
                } else if (parseFloat(precision.cambio) < 0) {
                    htmlCambio = `<i class="fas fa-arrow-down"></i> ${Math.abs(precision.cambio)}% desde última consulta`;
                    precisionCambio.className = 'small text-danger';
                } else {
                    htmlCambio = `<i class="fas fa-minus"></i> Sin cambios`;
                    precisionCambio.className = 'small text-warning';
                }
                precisionCambio.innerHTML = htmlCambio;
            }
            
            // 2. Actualizar adherencia al tratamiento
            const adherenciaValor = document.querySelector('.medical-section-title + .row .col-md-4:nth-child(2) .h1');
            const adherenciaCambio = document.querySelector('.medical-section-title + .row .col-md-4:nth-child(2) .small');
            
            if (adherenciaValor) {
                adherenciaValor.innerHTML = `<span class="text-success">${adherencia.valor}</span>/<span class="text-muted">5</span>`;
            }
            
            if (adherenciaCambio) {
                let htmlCambio = '';
                if (adherencia.cambio === 'mejora') {
                    htmlCambio = '<i class="fas fa-arrow-up"></i> Mejorando';
                    adherenciaCambio.className = 'small text-success';
                } else if (adherencia.cambio === 'empeora') {
                    htmlCambio = '<i class="fas fa-arrow-down"></i> Disminuyendo';
                    adherenciaCambio.className = 'small text-danger';
                } else {
                    htmlCambio = '<i class="fas fa-minus"></i> Sin cambios';
                    adherenciaCambio.className = 'small text-warning';
                }
                adherenciaCambio.innerHTML = htmlCambio;
            }
            
            // 3. Actualizar próxima revisión
            const revisionValor = document.querySelector('.medical-section-title + .row .col-md-4:nth-child(3) .small');
            
            if (revisionValor) {
                revisionValor.textContent = `En ${proximaRevision.dias} días`;
            }
        }
        
        // Manejador de telemedicina
        document.getElementById('telemedicine-btn')?.addEventListener('click', function() {
            if (telemedicineModal) {
                telemedicineModal.show();
            }
        });
        
        // Manejadores para botones de entrada por voz e imagen
        document.getElementById('voice-input-btn')?.addEventListener('click', function() {
            alert('Funcionalidad de entrada por voz en desarrollo');
        });
        
        document.getElementById('upload-image-btn')?.addEventListener('click', function() {
            // Crear un input de tipo archivo invisible
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            fileInput.style.display = 'none';
            document.body.appendChild(fileInput);
            
            // Activar el diálogo de selección de archivo
            fileInput.click();
            
            // Manejar la selección de archivos
            fileInput.addEventListener('change', async function() {
                if (fileInput.files && fileInput.files[0]) {
                    const file = fileInput.files[0];
                    
                    // Verificar que sea una imagen
                    if (!file.type.match('image.*')) {
                        alert('Por favor, seleccione una imagen válida');
                        document.body.removeChild(fileInput);
                        return;
                    }
                    
                    // Mostrar la imagen seleccionada en el chat
                    const reader = new FileReader();
                    reader.onload = async function(e) {
                        // Crear un mensaje con la imagen (marcar con ID único para actualización posterior)
                        const imageId = 'uploaded-image-' + Date.now();
                        const imagePreview = `<div class="mt-2 mb-2 text-center">
                                              <img id="${imageId}" src="${e.target.result}" alt="Imagen médica" style="max-width: 100%; max-height: 300px; border-radius: 8px;" class="user-uploaded-image">
                                              <div class="mt-1 small text-muted">Imagen subida para diagnóstico</div>
                                            </div>`;
                        
                        // Añadir la imagen como mensaje del usuario
                        const messagesContainer = document.getElementById('chat-messages');
                        const messageDiv = document.createElement('div');
                        messageDiv.className = 'message mb-3 text-end';
                        messageDiv.innerHTML = `
                            <div class="message-content p-3 rounded patient-message float-end" style="max-width: 85%; display: inline-block;">
                                <div>He subido esta imagen como complemento a mi consulta. Sé que el diagnóstico requerirá conversación adicional:</div>
                                ${imagePreview}
                            </div>
                            <div class="clearfix"></div>
                            <small class="text-muted text-end d-block mt-1">
                                <i class="fas fa-user"></i> Paciente - ${new Date().toLocaleString()}
                            </small>
                        `;
                        messagesContainer.appendChild(messageDiv);
                        
                        // Desplazarse al último mensaje
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                        
                        try {
                            // Preparar la imagen para enviar al servidor
                            const formData = new FormData();
                            formData.append('image', file);
                            formData.append('conversation_id', '{{ conversation.conversation_id }}');
                            formData.append('specialty', document.getElementById('active-specialty').textContent.toLowerCase());
                            formData.append('description', 'Imagen compartida durante la consulta como complemento a la conversación.');
                            
                            // Mostrar indicador de procesamiento
                            const processingDiv = document.createElement('div');
                            processingDiv.className = 'message mb-3';
                            processingDiv.innerHTML = `
                                <div class="message-content p-3 rounded system-message" style="max-width: 85%; display: inline-block;">
                                    <div class="d-flex align-items-center">
                                        <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                                            <span class="visually-hidden">Procesando imagen...</span>
                                        </div>
                                        Analizando imagen médica...
                                    </div>
                                </div>
                                <div class="clearfix"></div>
                                <small class="text-muted d-block mt-1">
                                    <i class="fas fa-cog"></i> Sistema - ${new Date().toLocaleString()}
                                </small>
                            `;
                            messagesContainer.appendChild(processingDiv);
                            messagesContainer.scrollTop = messagesContainer.scrollHeight;
                            
                            // Enviar la imagen al servidor
                            const response = await fetch('{{ url_for("image.api_analyze") }}', {
                                method: 'POST',
                                body: formData
                            });
                            
                            // Eliminar el indicador de procesamiento
                            messagesContainer.removeChild(processingDiv);
                            
                            if (response.ok) {
                                const data = await response.json();
                                
                                // Si el análisis fue exitoso, actualizar la imagen con la URL del servidor
                                if (data.success && data.image_url) {
                                    const uploadedImg = document.getElementById(imageId);
                                    if (uploadedImg) {
                                        uploadedImg.src = data.image_url;
                                        console.log('Imagen actualizada con URL del servidor:', data.image_url);
                                        
                                        // Actualizar contador de imágenes diagnósticas inmediatamente
                                        setTimeout(() => {
                                            getConversationImages().then(images => {
                                                updateDiagnosticImagesCount(images.length);
                                            });
                                        }, 500);
                                    }
                                }
                                
                                // Añadir la respuesta del análisis de imagen
                                const analysisDiv = document.createElement('div');
                                analysisDiv.className = 'message mb-3';
                                
                                if (data.success) {
                                    analysisDiv.innerHTML = `
                                        <div class="message-content p-3 rounded doctor-message" style="max-width: 85%; display: inline-block;">
                                            <div class="mb-2">
                                                <strong>Análisis complementario de imagen:</strong>
                                                <div class="alert alert-info py-1 px-2 mt-1 mb-2" style="font-size: 0.85rem;">
                                                    <i class="fas fa-info-circle me-1"></i> Este análisis visual es solo un complemento a nuestra conversación, no un diagnóstico completo.
                                                </div>
                                            </div>
                                            <div>${data.analysis || 'Imagen analizada correctamente.'}</div>
                                            <div class="mt-2 text-primary">
                                                <i class="fas fa-comment-medical me-1"></i> <strong>Por favor, continúe describiendo sus síntomas y detalles adicionales para complementar esta imagen.</strong>
                                            </div>
                                        </div>
                                        <div class="clearfix"></div>
                                        <small class="text-muted d-block mt-1">
                                            <i class="fas fa-user-md"></i> Dr. ${document.getElementById('active-specialty').textContent} - ${new Date().toLocaleString()}
                                        </small>
                                    `;
                                } else {
                                    // Mensaje de error más detallado
                                    let errorMessage = data.error || 'Error desconocido';
                                    let errorDetails = data.details || '';
                                    let troubleshootingTips = '';
                                    
                                    // Agregar consejos específicos según el tipo de error
                                    if (errorMessage.includes('API key') || errorMessage.includes('configuración')) {
                                        troubleshootingTips = `
                                            <div class="mt-2 small">
                                                <strong>💡 Para solucionarlo:</strong><br>
                                                1. Verifique que existe el archivo .env en la raíz del proyecto<br>
                                                2. Configure su OPENAI_API_KEY en el archivo .env<br>
                                                3. Reinicie el servidor después de la configuración
                                            </div>`;
                                    } else if (errorMessage.includes('médico')) {
                                        troubleshootingTips = `
                                            <div class="mt-2 small">
                                                <strong>💡 Intente con:</strong><br>
                                                • Imagen de síntomas visibles (erupciones, heridas, etc.)<br>
                                                • Radiografías o estudios médicos<br>
                                                • Fotografías de medicamentos o recetas
                                            </div>`;
                                    } else if (errorMessage.includes('formato') || errorMessage.includes('no permitido')) {
                                        let supportedFormats = 'PNG, JPG, JPEG, GIF, BMP, TIFF, WEBP';
                                        if (data.details && data.details.includes('Extensiones soportadas:')) {
                                            const match = data.details.match(/Extensiones soportadas: ([^,]+(?:, [^,]+)*)/);
                                            if (match) {
                                                supportedFormats = match[1].toUpperCase();
                                            }
                                        }
                                        troubleshootingTips = `
                                            <div class="mt-2 small">
                                                <strong>💡 Formatos soportados:</strong> ${supportedFormats}<br>
                                                <strong>Tamaño máximo:</strong> 16 MB<br>
                                                ${data.received_filename ? `<strong>Archivo recibido:</strong> ${data.received_filename}<br>` : ''}
                                                ${data.received_content_type ? `<strong>Tipo MIME:</strong> ${data.received_content_type}` : ''}
                                            </div>`;
                                    }
                                    
                                    analysisDiv.innerHTML = `
                                        <div class="message-content p-3 rounded system-message" style="max-width: 85%; display: inline-block;">
                                            <div class="text-danger">
                                                <i class="fas fa-exclamation-triangle me-2"></i>
                                                <strong>Error al analizar la imagen:</strong> ${errorMessage}
                                            </div>
                                            ${errorDetails ? `<div class="mt-1 small text-muted">${errorDetails}</div>` : ''}
                                            ${troubleshootingTips}
                                        </div>
                                        <div class="clearfix"></div>
                                        <small class="text-muted d-block mt-1">
                                            <i class="fas fa-cog"></i> Sistema - ${new Date().toLocaleString()}
                                        </small>
                                    `;
                                }
                                
                                messagesContainer.appendChild(analysisDiv);
                                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                            } else {
                                // Mostrar error detallado del servidor
                                let errorText = 'Error de comunicación con el servidor';
                                try {
                                    const errorData = await response.json();
                                    errorText = errorData.error || errorText;
                                    if (errorData.details) {
                                        errorText += ': ' + errorData.details;
                                    }
                                } catch (parseError) {
                                    errorText += ` (Status: ${response.status})`;
                                }
                                
                                const errorDiv = document.createElement('div');
                                errorDiv.className = 'message mb-3';
                                errorDiv.innerHTML = `
                                    <div class="message-content p-3 rounded system-message" style="max-width: 85%; display: inline-block;">
                                        <div class="text-danger">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            ${errorText}
                                        </div>
                                        <div class="mt-2 small">
                                            <strong>💡 Posibles soluciones:</strong><br>
                                            • Verifique su conexión a internet<br>
                                            • Asegúrese de que el archivo .env está configurado<br>
                                            • Intente reiniciar el servidor<br>
                                            • Visite <a href="/images/status" target="_blank">/images/status</a> para diagnóstico
                                        </div>
                                    </div>
                                    <div class="clearfix"></div>
                                    <small class="text-muted d-block mt-1">
                                        <i class="fas fa-cog"></i> Sistema - ${new Date().toLocaleString()}
                                    </small>
                                `;
                                messagesContainer.appendChild(errorDiv);
                                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                            }
                        } catch (error) {
                            console.error('Error al procesar la imagen:', error);
                            
                            // Mostrar error
                            const errorDiv = document.createElement('div');
                            errorDiv.className = 'message mb-3';
                            errorDiv.innerHTML = `
                                <div class="message-content p-3 rounded system-message" style="max-width: 85%; display: inline-block;">
                                    <div class="text-danger">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        Error al procesar la imagen: ${error.message || 'Error desconocido'}
                                    </div>
                                </div>
                                <div class="clearfix"></div>
                                <small class="text-muted d-block mt-1">
                                    <i class="fas fa-cog"></i> Sistema - ${new Date().toLocaleString()}
                                </small>
                            `;
                            messagesContainer.appendChild(errorDiv);
                            messagesContainer.scrollTop = messagesContainer.scrollHeight;
                        }
                    };
                    
                    // Leer el archivo como URL de datos
                    reader.readAsDataURL(file);
                }
                
                // Eliminar el input después de usarlo
                document.body.removeChild(fileInput);
            });
        });
        
        // Inicializar la página
        const messagesContainer = document.getElementById('chat-messages');
        if (messagesContainer) {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            // Realizar evaluación inicial de triaje
            evaluarTriaje();
            // Inicializar analítica IA
            actualizarAnaliticaIA();
        }
        
        // Simular actualización de signos vitales
        function updateVitalSigns() {
            const vitalValues = document.querySelectorAll('.vital-value');
            if (vitalValues.length > 0) {
                // Temperatura: variar entre 36.5 y 36.9
                vitalValues[0].textContent = (36.5 + Math.random() * 0.4).toFixed(1) + '°C';
                
                // Ritmo cardíaco: variar entre 70 y 75
                vitalValues[1].textContent = Math.floor(70 + Math.random() * 5) + ' bpm';
                
                // Respiración: variar entre 15 y 17
                vitalValues[2].textContent = Math.floor(15 + Math.random() * 2) + ' rpm';
                
                // Presión arterial: ligeras variaciones
                const systolic = Math.floor(119 + Math.random() * 3);
                const diastolic = Math.floor(79 + Math.random() * 3);
                vitalValues[3].textContent = systolic + '/' + diastolic;
            }
            
            // Programar próxima actualización
            setTimeout(updateVitalSigns, 5000);
        }
        
        // Iniciar simulación de signos vitales
        updateVitalSigns();
        
        // Función para añadir un mensaje al chat (mantener esta para el funcionamiento)
        function addMessage(content, sender, timestamp) {
            const messagesContainer = document.getElementById('chat-messages');
            const template = document.getElementById('message-template');
            const messageNode = template.content.cloneNode(true);
            
            // Configurar clase y estilos según el remitente
            const messageDiv = messageNode.querySelector('.message');
            const messageContent = messageNode.querySelector('.message-content');
            const messageText = messageNode.querySelector('.message-text');
            const messageSender = messageNode.querySelector('.message-sender');
            const messageTime = messageNode.querySelector('.message-time');
            
            // Configurar el contenido y metadatos
            messageText.textContent = content;
            messageTime.textContent = ' - ' + new Date(timestamp).toLocaleString();
            
            if (sender === 'user') {
                messageDiv.classList.add('text-end');
                messageContent.classList.add('patient-message', 'float-end');
                messageSender.innerHTML = '<i class="fas fa-user"></i> Paciente';
            } else if (sender === 'system') {
                messageContent.classList.add('system-message');
                messageSender.innerHTML = '<i class="fas fa-cog"></i> Sistema';
            } else {
                messageContent.classList.add('doctor-message');
                messageSender.innerHTML = '<i class="fas fa-user-md"></i> Dr. ' + sender.charAt(0).toUpperCase() + sender.slice(1);
            }
            
            // Añadir mensaje al contenedor
            messagesContainer.appendChild(messageNode);
            
            // Desplazarse al último mensaje
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Reevaluar triaje después de añadir un mensaje
            setTimeout(evaluarTriaje, 500);
        }
        
        // Manejar envío de mensajes
        document.getElementById('message-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const messageInput = document.getElementById('message-input');
            const message = messageInput.value.trim();
            
            if (!message) return;
            
            // Añadir mensaje del usuario al chat (presentación inmediata)
            addMessage(message, 'user', new Date().toISOString());
            
            // Limpiar el campo de entrada
            messageInput.value = '';
            
            try {
                // Mostrar indicador de escritura
                const typingIndicator = document.createElement('div');
                typingIndicator.className = 'message-typing mb-2';
                typingIndicator.innerHTML = '<div class="message-content p-2 rounded bg-light" style="max-width: 80%; display: inline-block;">Escribiendo...</div>';
                document.getElementById('chat-messages').appendChild(typingIndicator);
                
                // Enviar mensaje al servidor
                const formData = new FormData();
                formData.append('message', message);
                
                const response = await fetch('{{ url_for("interactive.send_message") }}', {
                    method: 'POST',
                    body: formData
                });
                
                // Eliminar indicador de escritura
                document.getElementById('chat-messages').removeChild(typingIndicator);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success && data.conversation) {
                        // Obtener el último mensaje del especialista
                        const messages = data.conversation.messages;
                        const lastMessage = messages[messages.length - 1];
                        
                        // Actualizar el especialista actual si ha cambiado
                        const newSpecialty = data.conversation.active_specialty;
                        if (newSpecialty && document.getElementById('active-specialty').textContent.toLowerCase() !== newSpecialty) {
                            document.getElementById('active-specialty').textContent = newSpecialty.charAt(0).toUpperCase() + newSpecialty.slice(1);
                            document.getElementById('header-specialty').textContent = newSpecialty.charAt(0).toUpperCase() + newSpecialty.slice(1);
                        }
                        
                        if (lastMessage && lastMessage.sender !== 'user') {
                            // Añadir respuesta del especialista al chat
                            addMessage(lastMessage.content, lastMessage.sender, lastMessage.timestamp);
                        }
                        
                        // Actualizar el triaje con el nuevo contenido
                        evaluarTriaje();
                        // Actualizar analítica IA
                        actualizarAnaliticaIA();
                    } else {
                        // Mostrar mensaje de error
                        addMessage(data.error || 'Error al procesar el mensaje', 'system', new Date().toISOString());
                    }
                } else {
                    // Mostrar mensaje de error
                    addMessage('Error de comunicación con el servidor', 'system', new Date().toISOString());
                }
            } catch (error) {
                console.error('Error:', error);
                addMessage('Error de comunicación con el servidor', 'system', new Date().toISOString());
            }
        });
        
        // Manejar generación de informes médicos
        document.getElementById('generate-report-btn')?.addEventListener('click', async function() {
            // Mostrar modal con indicador de carga
            if (reportModal) {
                reportModal.show();
                document.getElementById('report-loading').classList.remove('d-none');
                document.getElementById('report-content').classList.add('d-none');
            }
            
            try {
                // Llamar al endpoint para generar el informe
                const response = await fetch('{{ url_for("interactive.generate_report") }}', {
                    method: 'GET'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success && data.report) {
                        // Ocultar indicador de carga y mostrar informe
                        document.getElementById('report-loading').classList.add('d-none');
                        const reportContent = document.getElementById('report-content');
                        reportContent.innerHTML = data.report;
                        reportContent.classList.remove('d-none');
                    } else {
                        // Mostrar mensaje de error en el modal
                        document.getElementById('report-loading').classList.add('d-none');
                        const reportContent = document.getElementById('report-content');
                        reportContent.innerHTML = '<div class="alert alert-danger">Error al generar el informe médico: ' 
                            + (data.message || 'Error desconocido') + '</div>';
                        reportContent.classList.remove('d-none');
                    }
                } else {
                    // Mostrar mensaje de error en el modal
                    document.getElementById('report-loading').classList.add('d-none');
                    const reportContent = document.getElementById('report-content');
                    reportContent.innerHTML = '<div class="alert alert-danger">Error de comunicación con el servidor</div>';
                    reportContent.classList.remove('d-none');
                }
            } catch (error) {
                console.error('Error:', error);
                // Mostrar mensaje de error en el modal
                document.getElementById('report-loading').classList.add('d-none');
                const reportContent = document.getElementById('report-content');
                reportContent.innerHTML = '<div class="alert alert-danger">Error al generar el informe médico: ' + error.message + '</div>';
                reportContent.classList.remove('d-none');
            }
        });
        
        // Manejar descarga de informes
        document.getElementById('download-report-btn')?.addEventListener('click', function() {
            window.open('{{ url_for("interactive.download_report") }}', '_blank');
        });
        
        // ========== FUNCIONALIDAD DE RECURSOS MÉDICOS ==========
        
        // Inicializar modales de recursos médicos
        let medicationsModal, consultationsModal, labResultsModal, diagnosticImagesModal;
        
        try {
            medicationsModal = new bootstrap.Modal(document.getElementById('medications-modal'));
            consultationsModal = new bootstrap.Modal(document.getElementById('consultations-modal'));
            labResultsModal = new bootstrap.Modal(document.getElementById('lab-results-modal'));
            diagnosticImagesModal = new bootstrap.Modal(document.getElementById('diagnostic-images-modal'));
        } catch (err) {
            console.error("Error inicializando modales de recursos médicos:", err);
        }
        
        // Manejar clicks en elementos de recursos médicos
        document.querySelectorAll('.medical-resource-item').forEach(item => {
            item.addEventListener('click', function() {
                const resourceType = this.getAttribute('data-resource');
                handleResourceClick(resourceType);
            });
        });
        
        // Función principal para manejar clicks en recursos
        function handleResourceClick(resourceType) {
            switch(resourceType) {
                case 'medications':
                    loadMedications();
                    medicationsModal.show();
                    break;
                case 'consultations':
                    loadConsultations();
                    consultationsModal.show();
                    break;
                case 'lab-results':
                    loadLabResults();
                    labResultsModal.show();
                    break;
                case 'diagnostic-images':
                    loadDiagnosticImages();
                    diagnosticImagesModal.show();
                    break;
            }
        }
        
        // Función para cargar medicamentos
        async function loadMedications() {
            const loadingEl = document.getElementById('medications-loading');
            const contentEl = document.getElementById('medications-content');
            
            // Mostrar loading
            loadingEl.classList.remove('d-none');
            contentEl.classList.add('d-none');
            
            try {
                // Extraer medicamentos de la conversación actual
                const medications = extractMedicationsFromConversation();
                
                let content = '';
                
                if (medications.length === 0) {
                    content = `
                        <div class="text-center p-4">
                            <i class="fas fa-pills text-muted" style="font-size: 3rem;"></i>
                            <h4 class="mt-3 text-muted">No hay medicamentos recetados</h4>
                            <p class="text-muted">En esta consulta aún no se han recetado medicamentos.</p>
                        </div>
                    `;
                } else {
                    content = `
                        <div class="row">
                            <div class="col-12">
                                <h6 class="text-primary mb-3">
                                    <i class="fas fa-prescription-bottle-alt me-2"></i>
                                    Medicamentos recetados en esta consulta
                                </h6>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-primary">
                                    <tr>
                                        <th><i class="fas fa-pills me-2"></i>Medicamento</th>
                                        <th><i class="fas fa-weight me-2"></i>Dosis</th>
                                        <th><i class="fas fa-clock me-2"></i>Frecuencia</th>
                                        <th><i class="fas fa-calendar me-2"></i>Duración</th>
                                        <th><i class="fas fa-notes-medical me-2"></i>Instrucciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    medications.forEach(med => {
                        content += `
                            <tr>
                                <td><strong>${med.name}</strong></td>
                                <td>${med.dose}</td>
                                <td>${med.frequency}</td>
                                <td>${med.duration}</td>
                                <td>${med.instructions}</td>
                            </tr>
                        `;
                    });
                    
                    content += `
                                </tbody>
                            </table>
                        </div>
                        <div class="alert alert-info mt-3">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Importante:</strong> Siga las indicaciones médicas. Consulte con su médico antes de modificar dosis o suspender tratamiento.
                        </div>
                    `;
                }
                
                contentEl.innerHTML = content;
                updateMedicationsCount(medications.length);
                
                // Ocultar loading y mostrar contenido
                loadingEl.classList.add('d-none');
                contentEl.classList.remove('d-none');
                
            } catch (error) {
                console.error('Error cargando medicamentos:', error);
                contentEl.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error al cargar medicamentos. Por favor, intente nuevamente.
                    </div>
                `;
                loadingEl.classList.add('d-none');
                contentEl.classList.remove('d-none');
            }
        }
        
        // Función para cargar historial de consultas
        async function loadConsultations() {
            const loadingEl = document.getElementById('consultations-loading');
            const contentEl = document.getElementById('consultations-content');
            
            loadingEl.classList.remove('d-none');
            contentEl.classList.add('d-none');
            
            try {
                // Simular carga de datos (aquí harías una llamada al servidor)
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                const consultations = await getConsultationsHistory();
                
                let content = `
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h6 class="text-success">
                                <i class="fas fa-history me-2"></i>
                                Historial de Consultas
                            </h6>
                        </div>
                        <div class="col-md-6 text-end">
                            <span class="badge bg-success">${consultations.length} consultas realizadas</span>
                        </div>
                    </div>
                `;
                
                if (consultations.length === 0) {
                    content += `
                        <div class="text-center p-4">
                            <i class="fas fa-notes-medical text-muted" style="font-size: 3rem;"></i>
                            <h4 class="mt-3 text-muted">Primera consulta</h4>
                            <p class="text-muted">Esta es su primera consulta en el sistema.</p>
                        </div>
                    `;
                } else {
                    content += '<div class="timeline">';
                    
                    consultations.forEach((consultation, index) => {
                        const isActive = index === 0;
                        content += `
                            <div class="timeline-item ${isActive ? 'active' : ''}">
                                <div class="timeline-marker">
                                    <i class="fas fa-user-md"></i>
                                </div>
                                <div class="timeline-content">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between">
                                            <h6 class="mb-0">
                                                <i class="fas fa-stethoscope me-2"></i>
                                                ${consultation.specialty}
                                            </h6>
                                            <small class="text-muted">${consultation.date}</small>
                                        </div>
                                        <div class="card-body">
                                            <p class="card-text">${consultation.summary}</p>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <small><strong>Duración:</strong> ${consultation.duration}</small>
                                                </div>
                                                <div class="col-md-6">
                                                    <small><strong>Estado:</strong> 
                                                        <span class="badge bg-${consultation.status === 'completed' ? 'success' : 'warning'}">
                                                            ${consultation.status === 'completed' ? 'Completada' : 'En curso'}
                                                        </span>
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    content += '</div>';
                }
                
                contentEl.innerHTML = content;
                updateConsultationsCount(consultations.length);
                
                loadingEl.classList.add('d-none');
                contentEl.classList.remove('d-none');
                
            } catch (error) {
                console.error('Error cargando consultas:', error);
                contentEl.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error al cargar el historial. Por favor, intente nuevamente.
                    </div>
                `;
                loadingEl.classList.add('d-none');
                contentEl.classList.remove('d-none');
            }
        }
        
        // Función para cargar resultados de laboratorio
        async function loadLabResults() {
            const loadingEl = document.getElementById('lab-results-loading');
            const contentEl = document.getElementById('lab-results-content');
            
            loadingEl.classList.remove('d-none');
            contentEl.classList.add('d-none');
            
            try {
                const labResults = extractLabResultsFromConversation();
                
                let content = '';
                
                if (labResults.length === 0) {
                    content = `
                        <div class="text-center p-4">
                            <i class="fas fa-vial text-muted" style="font-size: 3rem;"></i>
                            <h4 class="mt-3 text-muted">No hay resultados de laboratorio</h4>
                            <p class="text-muted">En esta consulta no se han mencionado análisis o exámenes de laboratorio.</p>
                            <button class="btn btn-outline-primary mt-2">
                                <i class="fas fa-plus me-2"></i>Agregar resultados
                            </button>
                        </div>
                    `;
                } else {
                    content = `
                        <div class="row mb-3">
                            <div class="col-12">
                                <h6 class="text-warning">
                                    <i class="fas fa-flask me-2"></i>
                                    Resultados de Exámenes
                                </h6>
                            </div>
                        </div>
                        <div class="row">
                    `;
                    
                    labResults.forEach(result => {
                        content += `
                            <div class="col-md-6 mb-3">
                                <div class="card h-100">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">${result.test}</h6>
                                        <span class="badge bg-${result.status === 'normal' ? 'success' : result.status === 'abnormal' ? 'danger' : 'warning'}">
                                            ${result.status === 'normal' ? 'Normal' : result.status === 'abnormal' ? 'Anormal' : 'Pendiente'}
                                        </span>
                                    </div>
                                    <div class="card-body">
                                        <p><strong>Valor:</strong> ${result.value}</p>
                                        <p><strong>Rango normal:</strong> ${result.normalRange}</p>
                                        <p><strong>Fecha:</strong> ${result.date}</p>
                                        ${result.notes ? `<p><strong>Observaciones:</strong> ${result.notes}</p>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    content += '</div>';
                }
                
                contentEl.innerHTML = content;
                updateLabResultsCount(labResults.length);
                
                loadingEl.classList.add('d-none');
                contentEl.classList.remove('d-none');
                
            } catch (error) {
                console.error('Error cargando resultados de laboratorio:', error);
                contentEl.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error al cargar resultados. Por favor, intente nuevamente.
                    </div>
                `;
                loadingEl.classList.add('d-none');
                contentEl.classList.remove('d-none');
            }
        }
        
        // Función para cargar imágenes diagnósticas
        async function loadDiagnosticImages() {
            const loadingEl = document.getElementById('diagnostic-images-loading');
            const contentEl = document.getElementById('diagnostic-images-content');
            
            loadingEl.classList.remove('d-none');
            contentEl.classList.add('d-none');
            
            try {
                // Obtener imágenes tanto del frontend como del backend
                const images = await getConversationImages();
                
                let content = `
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h6 class="text-info">
                                <i class="fas fa-images me-2"></i>
                                Imágenes de esta Consulta
                            </h6>
                        </div>
                        <div class="col-md-6 text-end">
                            <span class="badge bg-info">${images.length} imágenes</span>
                        </div>
                    </div>
                `;
                
                if (images.length === 0) {
                    content += `
                        <div class="text-center p-4">
                            <i class="fas fa-x-ray text-muted" style="font-size: 3rem;"></i>
                            <h4 class="mt-3 text-muted">No hay imágenes diagnósticas</h4>
                            <p class="text-muted">En esta consulta no se han compartido imágenes médicas.</p>
                            <button class="btn btn-outline-info mt-2" onclick="document.getElementById('upload-image-btn').click()">
                                <i class="fas fa-camera me-2"></i>Agregar imagen
                            </button>
                        </div>
                    `;
                } else {
                    content += '<div class="row">';
                    
                    images.forEach((image, index) => {
                        content += `
                            <div class="col-md-6 col-lg-4 mb-3">
                                <div class="card h-100">
                                    <img src="${image.url}" class="card-img-top" alt="Imagen diagnóstica" 
                                         style="height: 200px; object-fit: cover; cursor: pointer;"
                                         onclick="showImageFullscreen('${image.url}', '${image.analysis}')">
                                    <div class="card-body">
                                        <h6 class="card-title">Imagen ${index + 1}</h6>
                                        <p class="card-text small">${image.analysis || 'Análisis pendiente'}</p>
                                        <small class="text-muted">Subida: ${image.uploadDate}</small>
                                    </div>
                                    <div class="card-footer">
                                        <button class="btn btn-sm btn-outline-info" onclick="downloadImage('${image.url}', 'imagen_${index + 1}')">
                                            <i class="fas fa-download"></i> Descargar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    content += '</div>';
                }
                
                contentEl.innerHTML = content;
                updateDiagnosticImagesCount(images.length);
                
                loadingEl.classList.add('d-none');
                contentEl.classList.remove('d-none');
                
            } catch (error) {
                console.error('Error cargando imágenes:', error);
                contentEl.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error al cargar imágenes. Por favor, intente nuevamente.
                    </div>
                `;
                loadingEl.classList.add('d-none');
                contentEl.classList.remove('d-none');
            }
        }
        
        // Funciones auxiliares para extraer información de la conversación
        function extractMedicationsFromConversation() {
            const messages = document.querySelectorAll('.message-content');
            const medications = [];
            
            messages.forEach(message => {
                const text = message.textContent.toLowerCase();
                
                // Buscar patrones de medicamentos
                const medicationPatterns = [
                    /(?:receto|prescribo|tome|tomar)\s+([a-zA-Záéíóúñ\s]+)\s+(?:(\d+(?:\.\d+)?)\s*(mg|g|ml|comprimidos?|cápsulas?|tabletas?))/gi,
                    /(?:medicamento|fármaco|medicina):\s*([a-zA-Záéíóúñ\s]+)/gi
                ];
                
                medicationPatterns.forEach(pattern => {
                    let match;
                    while ((match = pattern.exec(text)) !== null) {
                        medications.push({
                            name: match[1]?.trim() || 'Medicamento',
                            dose: match[2] ? `${match[2]} ${match[3]}` : 'Según indicación médica',
                            frequency: 'Según indicación médica',
                            duration: 'Según indicación médica',
                            instructions: 'Seguir indicaciones del médico'
                        });
                    }
                });
            });
            
            return medications;
        }
        
        function extractLabResultsFromConversation() {
            const messages = document.querySelectorAll('.message-content');
            const labResults = [];
            
            messages.forEach(message => {
                const text = message.textContent.toLowerCase();
                
                // Buscar patrones de resultados de laboratorio
                const labPatterns = [
                    /(?:análisis|examen|resultado|laboratorio|hemograma|glucosa|colesterol)/gi
                ];
                
                // Si encuentra menciones de laboratorio, crear entradas de ejemplo
                if (labPatterns.some(pattern => pattern.test(text))) {
                    // Agregar algunos resultados de ejemplo basados en el contexto
                    if (text.includes('glucosa') || text.includes('diabetes')) {
                        labResults.push({
                            test: 'Glucosa en ayunas',
                            value: '95 mg/dL',
                            normalRange: '70-100 mg/dL',
                            status: 'normal',
                            date: new Date().toLocaleDateString(),
                            notes: 'Resultado dentro de parámetros normales'
                        });
                    }
                    
                    if (text.includes('colesterol')) {
                        labResults.push({
                            test: 'Colesterol total',
                            value: '180 mg/dL',
                            normalRange: '<200 mg/dL',
                            status: 'normal',
                            date: new Date().toLocaleDateString(),
                            notes: 'Mantener dieta saludable'
                        });
                    }
                }
            });
            
            return labResults;
        }
        
        async function getConversationImages() {
            // Obtener imágenes que se han subido en esta conversación
            const images = [];
            
            // Buscar elementos de imagen en los mensajes
            const imageElements = document.querySelectorAll('#chat-messages img.user-uploaded-image');
            
            imageElements.forEach((img, index) => {
                // Verificar si es una imagen válida (tiene URL del servidor o es una imagen médica)
                if (img.src && (img.src.includes('uploads/images') || img.classList.contains('user-uploaded-image'))) {
                    images.push({
                        url: img.src,
                        analysis: img.alt || 'Imagen médica',
                        uploadDate: new Date().toLocaleDateString(),
                        index: index
                    });
                }
            });
            
            // También obtener imágenes del backend
            try {
                const response = await fetch(`/medical-resources/diagnostic-images/{{ conversation.conversation_id }}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.images) {
                        // Combinar imágenes del frontend y backend, evitando duplicados
                        data.images.forEach(backendImage => {
                            const exists = images.some(img => img.url === backendImage.url);
                            if (!exists) {
                                images.push({
                                    url: backendImage.url,
                                    analysis: backendImage.analysis || 'Imagen médica',
                                    uploadDate: backendImage.upload_date || new Date().toLocaleDateString(),
                                    index: images.length
                                });
                            }
                        });
                    }
                }
            } catch (error) {
                console.log('Error obteniendo imágenes del backend:', error);
            }
            
            return images;
        }
        
                 async function getConsultationsHistory() {
             try {
                 const response = await fetch('/medical-resources/consultations');
                 if (response.ok) {
                     const data = await response.json();
                     return data.consultations || [];
                 } else {
                     console.error('Error al obtener historial:', response.status);
                     return [];
                 }
             } catch (error) {
                 console.error('Error de red al obtener historial:', error);
                 // Fallback a datos simulados
                 return [
                     {
                         specialty: 'Medicina Interna',
                         date: new Date().toLocaleDateString(),
                         duration: '25 minutos',
                         summary: 'Consulta actual en curso. Evaluación de síntomas y seguimiento.',
                         status: 'in_progress'
                     }
                 ];
             }
         }
        
        // Funciones para actualizar contadores
        function updateMedicationsCount(count) {
            document.getElementById('medications-count').textContent = count;
        }
        
        function updateConsultationsCount(count) {
            document.getElementById('consultations-count').textContent = count;
        }
        
        function updateLabResultsCount(count) {
            document.getElementById('lab-results-count').textContent = count;
        }
        
        function updateDiagnosticImagesCount(count) {
            document.getElementById('diagnostic-images-count').textContent = count;
        }
        
        // Función para mostrar imagen en pantalla completa
        function showImageFullscreen(imageUrl, analysis) {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Imagen Diagnóstica</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body text-center">
                            <img src="${imageUrl}" class="img-fluid" alt="Imagen diagnóstica">
                            ${analysis ? `<div class="mt-3 alert alert-info">${analysis}</div>` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }
        
        // Función para descargar imagen
        function downloadImage(imageUrl, filename) {
            const link = document.createElement('a');
            link.href = imageUrl;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Inicializar contadores al cargar la página
        setTimeout(() => {
            const medications = extractMedicationsFromConversation();
            const labResults = extractLabResultsFromConversation();
            
            updateMedicationsCount(medications.length);
            updateLabResultsCount(labResults.length);
            
            // Actualizar contador de imágenes
            getConversationImages().then(images => {
                updateDiagnosticImagesCount(images.length);
            });
            
            // Actualizar contador de consultas
            getConsultationsHistory().then(consultations => {
                updateConsultationsCount(consultations.length);
            });
        }, 1000);
        
    });
</script>
{% endblock %} 